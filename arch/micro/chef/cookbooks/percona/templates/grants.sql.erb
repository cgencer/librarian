# Generated by Chef for <%= node["fqdn"] %>.
# Local modifications will be overwritten.

<% if node["platform_family"] == "debian" && node["percona"]["version"].to_f < 5.7 -%>
# debian-sys-maint user for administration
  <% [['SELECT', 'mysql.user'], ['SHUTDOWN', '*.*']].each do |priv, loc| %>
<%= "GRANT #{priv} ON #{loc} TO '#{@debian_user}'@'localhost';" %>
  <% end -%>
SET PASSWORD FOR '<%= @debian_user %>'@'localhost' = PASSWORD('<%= @debian_password %>');

<% end -%>
<% if node["percona"]["backup"]["configure"] %>
# Grant permissions for the XtraBackup user
# Ensure the user exists, then revoke all grants, then re-grant specific permissions
<% if node["percona"]["version"].to_i >= 8 %>
CREATE USER IF NOT EXISTS '<%= node["percona"]["backup"]["username"] %>'@'localhost' IDENTIFIED BY '<%= @backup_password %>';
GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO '<%= node["percona"]["backup"]["username"] %>'@'localhost';
REVOKE ALL PRIVILEGES, GRANT OPTION FROM '<%= node["percona"]["backup"]["username"] %>'@'localhost';
GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO '<%= node["percona"]["backup"]["username"] %>'@'localhost';
<% else -%>
GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO '<%= node["percona"]["backup"]["username"] %>'@'localhost' IDENTIFIED BY '<%= @backup_password %>';
REVOKE ALL PRIVILEGES, GRANT OPTION FROM '<%= node["percona"]["backup"]["username"] %>'@'localhost';
GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO '<%= node["percona"]["backup"]["username"] %>'@'localhost' IDENTIFIED BY '<%= @backup_password %>';
<% end -%>
<% end -%>

# Set the server root password. This should be preseeded by the package installation.
<% if node["percona"]["version"].to_i >= 8 %>
ALTER USER 'root'@'localhost' IDENTIFIED BY '<%= @root_password %>';
<% else -%>
SET PASSWORD FOR 'root'@'localhost' = PASSWORD('<%= @root_password %>');
<% end -%>

FLUSH PRIVILEGES;
